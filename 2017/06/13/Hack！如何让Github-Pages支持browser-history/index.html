<!DOCTYPE html>
<html lang=en>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="null">
  <meta name="keywords" content="undefined">
  
    <link rel="icon" href="">
  
  <title>Hack！如何让Github Pages支持browser history</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/atom-one-light.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
  <script src="/js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
  <div class="wrapper">
    <div class="default_title">
        <img src="/imgs/mycomputer.png" />
        <h1>stephen&#39;s blog</h1>
    </div>
    <ul class="topbar">
    
        <li>
        <a href="/" class="item-link">首页</a>
        </li>
    
        <li>
        <a href="/about" class="item-link">关于</a>
        </li>
    
    </ul>
    <div class="tag_list">
    <ul id="tag-list">
        <li><a href="/" ><img src="/imgs/disk.png" />(C:)</a>
        <ul>
        
            <li>
            <a href="/tags/js" title="js" rel="6">
                <img src="/imgs/folder.ico" />
                js
            </a>
            </li>    
        
            <li>
            <a href="/tags/nodeJs" title="nodeJs" rel="2">
                <img src="/imgs/folder.ico" />
                nodeJs
            </a>
            </li>    
        
            <li>
            <a href="/tags/源码分析" title="源码分析" rel="2">
                <img src="/imgs/folder.ico" />
                源码分析
            </a>
            </li>    
        
            <li>
            <a href="/tags/algorithm" title="algorithm" rel="1">
                <img src="/imgs/folder.ico" />
                algorithm
            </a>
            </li>    
        
            <li>
            <a href="/tags/translate" title="translate" rel="2">
                <img src="/imgs/folder.ico" />
                translate
            </a>
            </li>    
        
        </ul>
    </ul>
    </div>
    <div class="post_list">
    <ul>
        
            <li>
            <a href="/2017/09/13/A-color-picker-from-the-scratch/">
            <img src="/imgs/file.ico" />
                手把手实现一个 Color-Picker
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/Hack！如何让Github-Pages支持browser-history/">
            <img src="/imgs/file.ico" />
                Hack！如何让Github Pages支持browser history
            </a>
            </li>
        
            <li>
            <a href="/2017/06/03/2016-NingJS-JSConf-CN-2016-见闻/">
            <img src="/imgs/file.ico" />
                2016 NingJS(JSConf CN 2016) 见闻
            </a>
            </li>
        
            <li>
            <a href="/2017/06/17/Rethinking Asynchronous Programming in Javascript/">
            <img src="/imgs/file.ico" />
                Rethinking Asynchronous Programming in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/11/Understanding-Event-Loop-in-Javascript/">
            <img src="/imgs/file.ico" />
                Understanding Event Loop in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/10/Web-Real-time-Connection/">
            <img src="/imgs/file.ico" />
                Web Real-time Connection
            </a>
            </li>
        
            <li>
            <a href="/2017/06/09/bootstrap之CSS源码分析/">
            <img src="/imgs/file.ico" />
                bootstrap之CSS源码分析
            </a>
            </li>
        
            <li>
            <a href="/2017/07/15/从jquery源码看无new构造/">
            <img src="/imgs/file.ico" />
                从jquery源码看无new构造
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/最小编辑距离问题（Edit-Distance/">
            <img src="/imgs/file.ico" />
                最小编辑距离问题(Edit Distance)
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/深入浅出throttle和debounce/">
            <img src="/imgs/file.ico" />
                深入浅出throttle和debounce
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/［译］什么时候“不要”用箭头函数/">
            <img src="/imgs/file.ico" />
                ［译］什么时候“不要”用箭头函数
            </a>
            </li>
        
            <li>
            <a href="/2017/06/07/［译］关于vertical-align你应该知道的事/">
            <img src="/imgs/file.ico" />
                ［译］关于vertical-align你应该知道的事
            </a>
            </li>
        
            <li>
            <a href="/2017/07/31/LazyMan的几种解法/">
            <img src="/imgs/file.ico" />
                LazyMan的几种解法
            </a>
            </li>
        
            <li>
            <a href="/2017/06/08/Module-exports-vs-Exports-in-Node-js/">
            <img src="/imgs/file.ico" />
                Module.exports vs Exports in Node.js
            </a>
            </li>
        
    </ul>
    </div>

    <div class="post_total">
        
            <div class="left">[object Object] object(s)</div>
        
        <div class="right">&nbsp;</div>
    </div>
</div>
  <div class="content">
    <div class="post_title">
      <img src="/imgs/file.png" />
      <h1>Hack！如何让Github Pages支持browser history</h1>
      <a href="/"><div class="btn"><span class="fa fa-times"></span></div></a>
      <div class="btn btn_max"><span class="fa fa-window-maximize"></span></div>
      <div class="btn"><span class="fa fa-window-minimize"></span></div>
    </div>
    <ul class="topbar">
      <li>Tue Jun 13 2017 23:44:04 GMT+0800</li>
    </ul>
    <div class="post_content">
      <h2 id="问题提出"><a href="#问题提出" class="headerlink" title="问题提出"></a>问题提出</h2><p>之前我在写一个日记生成器的时候，大致思路是抓取github issues上的文章，然后使用react + react-router搭建SPA，最后部署到github pages上。其中遇到一个很麻烦的问题就是，github pages原生是不支持SPA的，举个例子：比如我们前端路由是<code>xxx.github.io/diary/post</code>，一旦刷新页面，github pages就会返回404，因为它并不知道这个路由<code>/post</code>，所以有什么解决办法呢？  </p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>github上已经有人提供了一种hack的解决办法，具体<a href="https://github.com/rafrex/spa-github-pages" target="_blank" rel="external">源码</a>在这里。接下来我们一步一步说明这个hack的方法是如何解决这个问题的：  </p>
<h3 id="404-html"><a href="#404-html" class="headerlink" title="404.html"></a>404.html</h3><p>首先我们需要提供一个404.html，当你刷新页面后，github pages是返回404的，所以这个404.html是为了覆盖原有的404页面。最关键的是，这个404页面需要提供一段脚本代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pathPrefix = <span class="literal">false</span>;</div><div class="line"><span class="keyword">var</span> l = <span class="built_in">window</span>.location;</div><div class="line">l.replace(</div><div class="line">    l.protocol + <span class="string">'//'</span> + l.hostname + (l.port ? <span class="string">':'</span> + l.port : <span class="string">''</span>) +</div><div class="line">    l.pathname.split(<span class="string">'/'</span>).slice(<span class="number">0</span>, <span class="number">2</span> * pathPrefix).join(<span class="string">'/'</span>) + <span class="string">'/?p=/'</span> +</div><div class="line">    l.pathname.slice(<span class="number">1</span>).split(<span class="string">'/'</span>).slice(pathPrefix).join(<span class="string">'/'</span>).replace(<span class="regexp">/&amp;/g</span>, <span class="string">'~and~'</span>) +</div><div class="line">    (l.search ? <span class="string">'&amp;q='</span> + l.search.slice(<span class="number">1</span>).replace(<span class="regexp">/&amp;/g</span>, <span class="string">'~and~'</span>) : <span class="string">''</span>) +</div><div class="line">    l.hash</div><div class="line">);</div></pre></td></tr></table></figure>
<p>这段代码啥意思呢？第一个pathPrefix我们先不管，看下面l.replace()，这个API是重载当前文档，并且不会产生新的历史纪录，即覆盖History对象中的当前纪录，后面的一段代码就是将当前的url转换成查询字符串以及hash片段，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ http://www.foo.tld/one/two?a=b&amp;c=d#qwe </div><div class="line"> -&gt;</div><div class="line">$ http://www.foo.tld/?p=/one/two&amp;q=a=b~and~c=d#qwe</div></pre></td></tr></table></figure>
<p>再说说pathPrefix，如果你的页面不是使用自定义域名，而是<code>xxx.github.io/xxx</code>，则应该设置为true，不然就为false，举个例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ https://username.github.io/repo-name/one/two?a=b&amp;c=d#qwe</div><div class="line"> -&gt; </div><div class="line">$ https://username.github.io/repo-name/?p=/one/two&amp;q=a=b~and~c=d#qwe</div></pre></td></tr></table></figure>
<p>这是因为需要保留repo的名称。说了这么多，这个到底有什么用呢？不急，继续看下面。</p>
<h3 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h3><p>Github pages在收到404.html新请求后（l.replace()重载文档会发送一个新请求，比如<code>/diary/post/2015</code>转换成了 <code>/diary/?p=/post/2015</code>），这时候会忽略查询参数和hash片段，返回index.html，相当于<code>/diary/index.html</code>，这时候魔法出现了，我们在index.html的头部加入以下代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">l</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (l.search) &#123;</div><div class="line">      <span class="keyword">var</span> q = &#123;&#125;;</div><div class="line">      l.search.slice(<span class="number">1</span>).split(<span class="string">'&amp;'</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> a = v.split(<span class="string">'='</span>);</div><div class="line">        q[a[<span class="number">0</span>]] = a.slice(<span class="number">1</span>).join(<span class="string">'='</span>).replace(<span class="regexp">/~and~/g</span>, <span class="string">'&amp;'</span>);</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">if</span> (q.p !== <span class="literal">undefined</span>) &#123;</div><div class="line">        <span class="built_in">window</span>.history.replaceState(<span class="literal">null</span>, <span class="literal">null</span>,</div><div class="line">          l.pathname.slice(<span class="number">0</span>, <span class="number">-1</span>) + (q.p || <span class="string">''</span>) +</div><div class="line">          (q.q ? (<span class="string">'?'</span> + q.q) : <span class="string">''</span>) +</div><div class="line">          l.hash</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;(<span class="built_in">window</span>.location))</div></pre></td></tr></table></figure>
<blockquote>
<p>注意这段代码必须在SPA加载之前执行，就是放在打包出来的bundle.js之前</p>
</blockquote>
<p>这段代码做了什么呢，第一是将url还原，即<code>/diary/?p=/post/2015</code> 还原为<code>/diary/post/2015</code>，然后使用history.replaceState()这个API添加到history对象中，不过注意这时候浏览器不会刷新页面，简单说把history想象成盒子，把url放到history盒子里去，但是不会加载这个url，只有等页面刷新，也就是SPA的js文件加载执行后，才会使用这个url，于是等SPA页面加载后，就会根据之前的url加载相应页面，也就解决了咱们的问题。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总体来说整个hack的过程是： 提供404.html -&gt; 加载脚本并请求index.html -&gt; 还原url并且加载应用。</p>

    </div>
</div>
  <footer class="footer">
  <p> powered by hexo</p>
</footer>
<script>
  var max = document.getElementsByClassName("btn")[1];
  var min = document.getElementsByClassName("btn")[2];

  function maximize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if (wid > 900) {
      widf = wid * 0.9;
      post.style.width = widf + "px";

      if (wid < 1400) {
        cont.style.width = "99%";
      } else {
        cont.style.width = "99.4%";
      }
    }
  }

  function minimize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if ( wid > 900 ) {
      post.style.width = "800px";
      cont.style.width = "98.5%";
    }
  }

  max && max.addEventListener('click', maximize, false);
  min && min.addEventListener('click', minimize, false);

</script>
</body>
</html>