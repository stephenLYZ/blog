<!DOCTYPE html>
<html lang=en>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="null">
  <meta name="keywords" content="undefined">
  
    <link rel="icon" href="">
  
  <title>LazyMan的几种解法</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/atom-one-light.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
  <script src="/js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
  <div class="wrapper">
    <div class="default_title">
        <img src="/imgs/mycomputer.png" />
        <h1>stephen&#39;s blog</h1>
    </div>
    <ul class="topbar">
    
        <li>
        <a href="/" class="item-link">首页</a>
        </li>
    
        <li>
        <a href="/about" class="item-link">关于</a>
        </li>
    
    </ul>
    <div class="tag_list">
    <ul id="tag-list">
        <li><a href="/" ><img src="/imgs/disk.png" />(C:)</a>
        <ul>
        
            <li>
            <a href="/tags/js" title="js" rel="6">
                <img src="/imgs/folder.ico" />
                js
            </a>
            </li>    
        
            <li>
            <a href="/tags/nodeJs" title="nodeJs" rel="2">
                <img src="/imgs/folder.ico" />
                nodeJs
            </a>
            </li>    
        
            <li>
            <a href="/tags/源码分析" title="源码分析" rel="2">
                <img src="/imgs/folder.ico" />
                源码分析
            </a>
            </li>    
        
            <li>
            <a href="/tags/algorithm" title="algorithm" rel="1">
                <img src="/imgs/folder.ico" />
                algorithm
            </a>
            </li>    
        
            <li>
            <a href="/tags/translate" title="translate" rel="2">
                <img src="/imgs/folder.ico" />
                translate
            </a>
            </li>    
        
        </ul>
    </ul>
    </div>
    <div class="post_list">
    <ul>
        
            <li>
            <a href="/2017/09/13/A-color-picker-from-the-scratch/">
            <img src="/imgs/file.ico" />
                手把手实现一个 Color-Picker
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/Hack！如何让Github-Pages支持browser-history/">
            <img src="/imgs/file.ico" />
                Hack！如何让Github Pages支持browser history
            </a>
            </li>
        
            <li>
            <a href="/2017/06/03/2016-NingJS-JSConf-CN-2016-见闻/">
            <img src="/imgs/file.ico" />
                2016 NingJS(JSConf CN 2016) 见闻
            </a>
            </li>
        
            <li>
            <a href="/2017/06/17/Rethinking Asynchronous Programming in Javascript/">
            <img src="/imgs/file.ico" />
                Rethinking Asynchronous Programming in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/11/Understanding-Event-Loop-in-Javascript/">
            <img src="/imgs/file.ico" />
                Understanding Event Loop in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/10/Web-Real-time-Connection/">
            <img src="/imgs/file.ico" />
                Web Real-time Connection
            </a>
            </li>
        
            <li>
            <a href="/2017/06/09/bootstrap之CSS源码分析/">
            <img src="/imgs/file.ico" />
                bootstrap之CSS源码分析
            </a>
            </li>
        
            <li>
            <a href="/2017/07/15/从jquery源码看无new构造/">
            <img src="/imgs/file.ico" />
                从jquery源码看无new构造
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/最小编辑距离问题（Edit-Distance/">
            <img src="/imgs/file.ico" />
                最小编辑距离问题(Edit Distance)
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/深入浅出throttle和debounce/">
            <img src="/imgs/file.ico" />
                深入浅出throttle和debounce
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/［译］什么时候“不要”用箭头函数/">
            <img src="/imgs/file.ico" />
                ［译］什么时候“不要”用箭头函数
            </a>
            </li>
        
            <li>
            <a href="/2017/06/07/［译］关于vertical-align你应该知道的事/">
            <img src="/imgs/file.ico" />
                ［译］关于vertical-align你应该知道的事
            </a>
            </li>
        
            <li>
            <a href="/2017/07/31/LazyMan的几种解法/">
            <img src="/imgs/file.ico" />
                LazyMan的几种解法
            </a>
            </li>
        
            <li>
            <a href="/2017/06/08/Module-exports-vs-Exports-in-Node-js/">
            <img src="/imgs/file.ico" />
                Module.exports vs Exports in Node.js
            </a>
            </li>
        
    </ul>
    </div>

    <div class="post_total">
        
            <div class="left">[object Object] object(s)</div>
        
        <div class="right">&nbsp;</div>
    </div>
</div>
  <div class="content">
    <div class="post_title">
      <img src="/imgs/file.png" />
      <h1>LazyMan的几种解法</h1>
      <a href="/"><div class="btn"><span class="fa fa-times"></span></div></a>
      <div class="btn btn_max"><span class="fa fa-window-maximize"></span></div>
      <div class="btn"><span class="fa fa-window-minimize"></span></div>
    </div>
    <ul class="topbar">
      <li>Mon Jul 31 2017 16:41:31 GMT+0800</li>
    </ul>
    <div class="post_content">
      <h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>LazyMan是一道很经典的前端面试题，题目非常有意思，完整描述是：</p>
<blockquote>
<p>实现一个LazyMan，可以按照以下方式调用:<br>LazyMan(“Hank”)输出:<br>Hi! This is Hank!</p>
<p>LazyMan(“Hank”).sleep(10).eat(“dinner”)输出<br>Hi! This is Hank!<br>//等待10秒..<br>Wake up after 10<br>Eat dinner~</p>
<p>LazyMan(“Hank”).eat(“dinner”).eat(“supper”)输出<br>Hi This is Hank!<br>Eat dinner~<br>Eat supper~</p>
<p>LazyMan(“Hank”).sleepFirst(5).eat(“supper”)输出<br>//等待5秒<br>Wake up after 5<br>Hi This is Hank!<br>Eat supper</p>
<p>以此类推。</p>
</blockquote>
<p>这道题主要考察的是JS里面的流程控制，如何让任务顺序实现以及如何正确链式调用是解决这道题的关键，网上大部分解法是借鉴express中间件原理，每一个行为执行完成后调用next()方法，然后使用setTimeout来执行下一个任务，如果你对js中的EventLoop、任务队列不了解的话，可以看我之前的这篇文章<a href="http://stephenliu.site/2017/06/11/Understanding-Event-Loop-in-Javascript/">Understanding Event Loop in Javascript</a>。下面主要讲解通过next方法、promise方法两种方法来实现。</p>
<h2 id="Next"><a href="#Next" class="headerlink" title="Next()"></a>Next()</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyManClass</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(name) &#123;</div><div class="line">    <span class="keyword">this</span>.tasks = [];</div><div class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123; </div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Hi, this is '</span> + name)</div><div class="line">      <span class="keyword">this</span>.next()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.tasks.push(fn)</div><div class="line">    setTimeout(<span class="keyword">this</span>.next.bind(<span class="keyword">this</span>), <span class="number">0</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  next() &#123;</div><div class="line">    <span class="keyword">let</span> fn = <span class="keyword">this</span>.tasks.shift()</div><div class="line">    fn &amp;&amp; fn.call(<span class="keyword">this</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  sleep(time) &#123;</div><div class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Wake up after '</span> + time)</div><div class="line">        <span class="keyword">this</span>.next()</div><div class="line">      &#125;, time * <span class="number">1000</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.tasks.push(fn)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  sleepFirst(time) &#123;</div><div class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Wake up after '</span> + time)</div><div class="line">        <span class="keyword">this</span>.next()</div><div class="line">      &#125;, time * <span class="number">1000</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.tasks.unshift(fn)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  eat(name) &#123;</div><div class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Eat '</span> + name)</div><div class="line">      <span class="keyword">this</span>.next()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.tasks.push(fn)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> LazyMan = <span class="function">(<span class="params">name</span>) =&gt;</span> <span class="keyword">new</span> LazyManClass(name)</div><div class="line"></div><div class="line">LazyMan(<span class="string">'stephen'</span>).sleep(<span class="number">5</span>).eat(<span class="string">'lunch'</span>)</div><div class="line"><span class="comment">// "Hi, this is stephen"</span></div><div class="line"><span class="comment">// 等待5s.. </span></div><div class="line"><span class="comment">// "Wake up after 1"</span></div><div class="line"><span class="comment">// "Eat lunch"</span></div></pre></td></tr></table></figure>
<p><a href="https://jsbin.com/yazatumuxe/edit?js,console" target="_blank" rel="external">点击查看代码</a><br>其中setTimeout模拟事件循环，使用this.tasks当作任务处理队列，每个事件内部有一个next方法当作事件调度函数。注意每个事件需要返回this来支持链式调用，下面看看promise的实现方法。</p>
<h2 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h2><p>这里我们可以使用Promise来实现，关于promise可以看这张图：<br><img src="https://bbsmax.ikafan.com/static/L3Byb3h5L2h0dHAvaW1hZ2VzMjAxNS5jbmJsb2dzLmNvbS9ibG9nLzYwMzgzNC8yMDE3MDEvNjAzODM0LTIwMTcwMTA3MjEyNjU4NzUzLTIzOTQyNDMxMC5wbmc=.jpg" alt=""></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyManClass</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(name) &#123;</div><div class="line">    <span class="keyword">this</span>.promiseTasks = []</div><div class="line">    <span class="keyword">this</span>.sequence = <span class="built_in">Promise</span>.resolve()</div><div class="line">    <span class="keyword">let</span> promiseObj = <span class="function"><span class="params">()</span> =&gt;</span> &#123; </div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Hi, this is '</span> + name)</div><div class="line">        resolve()</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.promiseTasks.push(promiseObj)</div><div class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">this</span>.promiseTasks.forEach(<span class="function">(<span class="params">promiseObj</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">let</span> thenFunc = <span class="function"><span class="params">()</span> =&gt;</span> promiseObj()</div><div class="line">        <span class="keyword">this</span>.sequence = <span class="keyword">this</span>.sequence.then(thenFunc)</div><div class="line">      &#125;)</div><div class="line">    &#125;, <span class="number">0</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  sleep(time) &#123;</div><div class="line">    <span class="keyword">let</span> promiseObj = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">          <span class="built_in">console</span>.log(<span class="string">'Wake up after '</span> + time)</div><div class="line">          resolve()</div><div class="line">        &#125;, time * <span class="number">1000</span>)</div><div class="line">      &#125;) </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.promiseTasks.push(promiseObj)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  sleepFirst(time) &#123;</div><div class="line">    <span class="keyword">let</span> promiseObj = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">          <span class="built_in">console</span>.log(<span class="string">'Wake up after '</span> + time)</div><div class="line">          resolve()</div><div class="line">        &#125;, time * <span class="number">1000</span>)</div><div class="line">      &#125;) </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.promiseTasks.unshift(promiseObj)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  eat(name) &#123;</div><div class="line">    <span class="keyword">let</span> promiseObj = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Eat '</span> + name)</div><div class="line">        resolve()</div><div class="line">      &#125;) </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.promiseTasks.push(promiseObj)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> LazyMan = <span class="function">(<span class="params">name</span>) =&gt;</span> <span class="keyword">new</span> LazyManClass(name)</div><div class="line"></div><div class="line">LazyMan(<span class="string">'stephen'</span>).eat(<span class="string">'lunch'</span>).sleep(<span class="number">2</span>).eat(<span class="string">'dinner'</span>)</div></pre></td></tr></table></figure>
<p><a href="https://jsbin.com/mubusudeba/edit?js,console" target="_blank" rel="external">点击查看代码</a><br>可以说使用promise控制流程非常方便，不过注意的是then接受的函数必须是已经确定状态的（resovle或者reject）。</p>
<p>(完)</p>

    </div>
</div>
  <footer class="footer">
  <p> powered by hexo</p>
</footer>
<script>
  var max = document.getElementsByClassName("btn")[1];
  var min = document.getElementsByClassName("btn")[2];

  function maximize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if (wid > 900) {
      widf = wid * 0.9;
      post.style.width = widf + "px";

      if (wid < 1400) {
        cont.style.width = "99%";
      } else {
        cont.style.width = "99.4%";
      }
    }
  }

  function minimize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if ( wid > 900 ) {
      post.style.width = "800px";
      cont.style.width = "98.5%";
    }
  }

  max && max.addEventListener('click', maximize, false);
  min && min.addEventListener('click', minimize, false);

</script>
</body>
</html>