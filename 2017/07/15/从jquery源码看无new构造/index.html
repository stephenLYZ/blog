<!DOCTYPE html>
<html lang=en>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="null">
  <meta name="keywords" content="undefined">
  
    <link rel="icon" href="">
  
  <title>从jquery源码看无new构造</title>
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/atom-one-light.css">
<link rel="stylesheet" href="/css/font-awesome.min.css">
  <script src="/js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
  <div class="wrapper">
    <div class="default_title">
        <img src="/imgs/mycomputer.png" />
        <h1>stephen&#39;s blog</h1>
    </div>
    <ul class="topbar">
    
        <li>
        <a href="/" class="item-link">首页</a>
        </li>
    
        <li>
        <a href="/about" class="item-link">关于</a>
        </li>
    
    </ul>
    <div class="tag_list">
    <ul id="tag-list">
        <li><a href="/" ><img src="/imgs/disk.png" />(C:)</a>
        <ul>
        
            <li>
            <a href="/tags/js" title="js" rel="6">
                <img src="/imgs/folder.ico" />
                js
            </a>
            </li>    
        
            <li>
            <a href="/tags/nodeJs" title="nodeJs" rel="2">
                <img src="/imgs/folder.ico" />
                nodeJs
            </a>
            </li>    
        
            <li>
            <a href="/tags/源码分析" title="源码分析" rel="2">
                <img src="/imgs/folder.ico" />
                源码分析
            </a>
            </li>    
        
            <li>
            <a href="/tags/algorithm" title="algorithm" rel="1">
                <img src="/imgs/folder.ico" />
                algorithm
            </a>
            </li>    
        
            <li>
            <a href="/tags/translate" title="translate" rel="2">
                <img src="/imgs/folder.ico" />
                translate
            </a>
            </li>    
        
        </ul>
    </ul>
    </div>
    <div class="post_list">
    <ul>
        
            <li>
            <a href="/2017/09/13/A-color-picker-from-the-scratch/">
            <img src="/imgs/file.ico" />
                手把手实现一个 Color-Picker
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/Hack！如何让Github-Pages支持browser-history/">
            <img src="/imgs/file.ico" />
                Hack！如何让Github Pages支持browser history
            </a>
            </li>
        
            <li>
            <a href="/2017/06/03/2016-NingJS-JSConf-CN-2016-见闻/">
            <img src="/imgs/file.ico" />
                2016 NingJS(JSConf CN 2016) 见闻
            </a>
            </li>
        
            <li>
            <a href="/2017/06/17/Rethinking Asynchronous Programming in Javascript/">
            <img src="/imgs/file.ico" />
                Rethinking Asynchronous Programming in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/11/Understanding-Event-Loop-in-Javascript/">
            <img src="/imgs/file.ico" />
                Understanding Event Loop in Javascript
            </a>
            </li>
        
            <li>
            <a href="/2017/06/10/Web-Real-time-Connection/">
            <img src="/imgs/file.ico" />
                Web Real-time Connection
            </a>
            </li>
        
            <li>
            <a href="/2017/06/09/bootstrap之CSS源码分析/">
            <img src="/imgs/file.ico" />
                bootstrap之CSS源码分析
            </a>
            </li>
        
            <li>
            <a href="/2017/07/15/从jquery源码看无new构造/">
            <img src="/imgs/file.ico" />
                从jquery源码看无new构造
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/最小编辑距离问题（Edit-Distance/">
            <img src="/imgs/file.ico" />
                最小编辑距离问题(Edit Distance)
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/深入浅出throttle和debounce/">
            <img src="/imgs/file.ico" />
                深入浅出throttle和debounce
            </a>
            </li>
        
            <li>
            <a href="/2017/06/13/［译］什么时候“不要”用箭头函数/">
            <img src="/imgs/file.ico" />
                ［译］什么时候“不要”用箭头函数
            </a>
            </li>
        
            <li>
            <a href="/2017/06/07/［译］关于vertical-align你应该知道的事/">
            <img src="/imgs/file.ico" />
                ［译］关于vertical-align你应该知道的事
            </a>
            </li>
        
            <li>
            <a href="/2017/07/31/LazyMan的几种解法/">
            <img src="/imgs/file.ico" />
                LazyMan的几种解法
            </a>
            </li>
        
            <li>
            <a href="/2017/06/08/Module-exports-vs-Exports-in-Node-js/">
            <img src="/imgs/file.ico" />
                Module.exports vs Exports in Node.js
            </a>
            </li>
        
    </ul>
    </div>

    <div class="post_total">
        
            <div class="left">[object Object] object(s)</div>
        
        <div class="right">&nbsp;</div>
    </div>
</div>
  <div class="content">
    <div class="post_title">
      <img src="/imgs/file.png" />
      <h1>从jquery源码看无new构造</h1>
      <a href="/"><div class="btn"><span class="fa fa-times"></span></div></a>
      <div class="btn btn_max"><span class="fa fa-window-maximize"></span></div>
      <div class="btn"><span class="fa fa-window-minimize"></span></div>
    </div>
    <ul class="topbar">
      <li>Sat Jul 15 2017 01:04:36 GMT+0800</li>
    </ul>
    <div class="post_content">
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>无new构造是怎么一回事呢？我们知道，jquery中可以通过以下两种方式来构造对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 无new</span></div><div class="line">$(<span class="string">'#id'</span>).context(<span class="string">'hello world'</span>) </div><div class="line"><span class="comment">// 有new</span></div><div class="line"><span class="keyword">var</span> id = <span class="keyword">new</span> $(<span class="string">'#id'</span>)</div><div class="line">id.context(<span class="string">'hello world'</span>)</div></pre></td></tr></table></figure>
<p>显然，我们用得最多就是第一种无new的构造方式，那这种方式内部又是怎么实现的呢？下面我们一步步来实现这样的效果。<br>js中函数是一等公民，我们在用oop形式编程的时候，很容易的会使用类来实例化对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 构造函数</span></div><div class="line"><span class="keyword">var</span> cQuery = <span class="function"><span class="keyword">function</span>(<span class="params">selector, contex</span>)</span>&#123;</div><div class="line">&#125;</div><div class="line">cQuery.prototype = &#123;</div><div class="line">	<span class="attr">setName</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name = name</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">name</span>: <span class="string">'stephen'</span>,</div><div class="line">	<span class="attr">age</span>: <span class="number">20</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> cQuery()</div><div class="line">c.age  <span class="comment">// 20</span></div></pre></td></tr></table></figure>
<p>如果我们想通过无new来构造对象的话，我们第一反应可能是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cQuery = <span class="function"><span class="keyword">function</span>(<span class="params">selector, contex</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> cQuery()</div><div class="line">&#125;</div><div class="line">cQuery.prototype = &#123;</div><div class="line">	<span class="attr">setName</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name = name</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">name</span>: <span class="string">'stephen'</span>,</div><div class="line">	<span class="attr">age</span>: <span class="number">20</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们会发现这样就陷入了一个无穷的循环之中，显然是不行的。我们其实可以把cQuery类当作一个工厂方法来创建实例，把这个方法放cQuery.prototye原型对象中:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cQuery = <span class="function"><span class="keyword">function</span>(<span class="params">selector, contex</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> cQuery.prototype.init()</div><div class="line">&#125;</div><div class="line">cQuery.prototype = &#123;</div><div class="line">	<span class="attr">init</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">	&#125;,</div><div class="line">	<span class="attr">setName</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name = name</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">name</span>: <span class="string">'stephen'</span>,</div><div class="line">	<span class="attr">age</span>: <span class="number">20</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看起来似乎解决了我们的问题，但是如果我们想在init使用this呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cQuery = <span class="function"><span class="keyword">function</span>(<span class="params">selector, contex</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> cQuery.prototype.init()</div><div class="line">&#125;</div><div class="line">cQuery.prototype = &#123;</div><div class="line">	<span class="attr">init</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">this</span>.age = <span class="number">18</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span></div><div class="line">	&#125;,</div><div class="line">	<span class="attr">setName</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name = name</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">name</span>: <span class="string">'stephen'</span>,</div><div class="line">	<span class="attr">age</span>: <span class="number">20</span></div><div class="line">&#125;</div><div class="line">cQuery().age  <span class="comment">//18</span></div><div class="line">cQuery().name  <span class="comment">//undefined</span></div></pre></td></tr></table></figure>
<p>显然，这时候由于是实例init()函数，所以this和原来cQuery的this作用域分离了，age会指向init中的age，而name由于init中未定义，所以为undefine。 这显然不是我们要的效果，那我们该解决呢？ 其实很简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cQuery.prototype.init.prototype = cQuery.prototype</div></pre></td></tr></table></figure>
<p>这便是最精妙的地方，将cQuery的prototype的属性赋给init的prototype，这样就保证了this虽然指向init，但仍然继承aQuery上的属性。<br>上面内容其实就是jquery中实现无new构造的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">window, undefined</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">　　jQuery = <span class="function"><span class="keyword">function</span>(<span class="params">selector, context</span>) </span>&#123;</div><div class="line">        <span class="comment">// The jQuery object is actually just the init constructor 'enhanced'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> jQuery.fn.init(selector, context, rootjQuery);</div><div class="line">    &#125;,</div><div class="line">    jQuery.fn = jQuery.prototype = &#123;</div><div class="line">        <span class="attr">init</span>: <span class="function"><span class="keyword">function</span>(<span class="params">selector, context, rootjQuery</span>) </span>&#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    jQuery.fn.init.prototype = jQuery.fn;</div><div class="line">&#125;)(<span class="built_in">window</span>);</div></pre></td></tr></table></figure>
<p>最后在谈谈underscore中的无new构造，放上源码注释：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;  </div><div class="line">        <span class="comment">// 如果Obj已经是underscore对象，则原样返回</span></div><div class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj); </div><div class="line">        <span class="comment">// 采用这种写法即使没用new操作符也可以构造新undersocre对象</span></div><div class="line">        <span class="keyword">this</span>._wrapped = obj; </div><div class="line">        <span class="comment">// underscore对象有实例属性_wrapped，保存着obj（用户传入的待处理的数据）</span></div><div class="line">      &#125;;</div><div class="line">      </div><div class="line">root._ = _</div></pre></td></tr></table></figure>
<p>其实也很简单，判断是否为underscore的对象，是就直接返回，不是就new一下（注意： 这里不会造成死循环的原因是因为第一个判断的存在 。</p>

    </div>
</div>
  <footer class="footer">
  <p> powered by hexo</p>
</footer>
<script>
  var max = document.getElementsByClassName("btn")[1];
  var min = document.getElementsByClassName("btn")[2];

  function maximize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if (wid > 900) {
      widf = wid * 0.9;
      post.style.width = widf + "px";

      if (wid < 1400) {
        cont.style.width = "99%";
      } else {
        cont.style.width = "99.4%";
      }
    }
  }

  function minimize () {
    var post = document.getElementsByClassName("content")[0];
    var cont = document.getElementsByClassName("post_content")[0];
    var wid = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName("body")[0].clientWidth;

    if ( wid > 900 ) {
      post.style.width = "800px";
      cont.style.width = "98.5%";
    }
  }

  max && max.addEventListener('click', maximize, false);
  min && min.addEventListener('click', minimize, false);

</script>
</body>
</html>